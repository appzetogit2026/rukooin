# FCM Token Update API Documentation

This documentation provides details on how to update the Firebase Cloud Messaging (FCM) token for Users and Partners. This is essential for delivering push notifications to devices.

## 1. Overview
The endpoint allows an authenticated user (User or Partner) to register or update their device's FCM token. The backend stores these tokens to send targeted push notifications via Firebase.

- **Endpoint**: `/api/auth/update-fcm`
- **Method**: `PUT`
- **Auth Required**: Yes (Bearer Token)
- **Content-Type**: `application/json`

---

## 2. Request Headers
| Header | Value | Description |
| :--- | :--- | :--- |
| **Authorization** | `Bearer <JWT_TOKEN>` | The token received after successful login/OTP verification. |
| **Content-Type** | `application/json` | Required for parsing JSON body. |

---

## 3. Request Body
The body should contain the `fcmToken` and optionally the `platform` type.

```json
{
  "fcmToken": "eXample_fcm_token_string_from_firebase...",
  "platform": "app" 
}
```

### Fields:
- `fcmToken` (String, Required): The registration token generated by the FCM SDK on the device.
- `platform` (String, Optional): Use `app` for mobile devices (Flutter) or `web` for browser-based sessions. Default is handled by the backend logic.

---

## 4. Response
### Success (200 OK)
```json
{
  "success": true,
  "message": "FCM Token updated successfully"
}
```

### Error: Missing Token (400 Bad Request)
```json
{
  "message": "fcmToken is required"
}
```

### Error: Unauthorized (401/403)
If the Bearer token is missing, expired, or invalid.

---

## 5. Flutter Integration (Webview Context)

In a Flutter Webview app, the Flutter layer should ideally get the FCM token using the `firebase_messaging` package and then pass it to the Webview's JavaScript context or call this API directly using an `http` client.

### Direct API Call from Flutter (Recommended)
```dart
Future<void> updateFCMToken(String token, String jwtToken) async {
  final response = await http.put(
    Uri.parse('https://api.rukkoo.in/api/auth/update-fcm'),
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer $jwtToken',
    },
    body: jsonEncode({
      'fcmToken': token,
      'platform': 'app'
    }),
  );

  if (response.statusCode == 200) {
    print("FCM Token Updated Successfully");
  } else {
    print("Failed to update FCM Token: ${response.body}");
  }
}
```

### When to Call this API?
1. **After Login/Registration**: As soon as the user logs in and you have the JWT token.
2. **On Token Refresh**: Use the `FirebaseMessaging.instance.onTokenRefresh` stream to update the token if it changes while the app is running.
